<launch>
    <arg name="offline"          default="false"/>

	<group ns="porter">

		<include unless="$(arg offline)"
			file="$(find realsense2_camera)/launch/rs_camera.launch">

			<arg name="camera"	value="rs_camera"/>

			<arg name="enable_color"        value="true"/>
			<arg name="enable_fisheye"	value="false"/>
			<arg name="enable_depth"        value="true"/>
			<arg name="enable_gyro"         value="true"/>
			<arg name="enable_accel"        value="true"/>
			<arg name="enable_infra1"       value="false"/>
			<arg name="enable_infra2"       value="false"/>

			<arg name="color_width"         default="640"/>
			<arg name="color_height"        default="480"/>
			<arg name="depth_width"         default="640"/>
			<arg name="depth_height"        default="480"/>
			<arg name="gyro_fps"            value="400"/>
			<arg name="accel_fps"           value="250"/>

			<arg name="align_depth"	value="true"/>
			<arg name="linear_accel_cov"	value="1.0"/>
			<arg name="unite_imu_method"	value="linear_interpolation"/>
			</include>

			<node pkg="imu_filter_madgwick" type="imu_filter_node" name="ImuFilter">
			<param name="use_mag" type="bool" value="false" />
			<param name="_publish_tf" type="bool" value="false" />
			<param name="_world_frame" type="string" value="enu" />
			<remap from="/porter/imu/data_raw" to="/porter/rs_camera/imu"/>
		</node>


		<include file="$(find rtabmap_ros)/launch/rtabmap.launch">
			<arg name="args" value="--delete_db_on_start"/>
			<arg name="frame_id" value="chasiss" />
			<arg name="rgb_topic" value="/porter/rs_camera/color/image_raw"/>
			<arg name="depth_topic" value="/porter/rs_camera/aligned_depth_to_color/image_raw"/>
			<arg name="camera_info_topic" value="/porter/rs_camera/color/camera_info"/>
			<arg name="depth_camera_info_topic" value="/porter/rs_camera/depth/camera_info"/>
			<arg name="rtabmapviz" value="false"/>
			<arg name="rviz" value="true"/>
		</include>
		
		<node pkg="nodelet" type="nodelet" name="nodelet_manager"  args="manager"/>

		<!-- Generate a point cloud from the depth image -->
		<node pkg="nodelet" type="nodelet" name="rgbd2cloud" args="load rtabmap_ros/point_cloud_xyzrgb nodelet_manager __name:=rgbd2cloud">
			 <remap from="rgb/image"       to="rs_camera/color/image_raw"/>
			 <remap from="depth/image"       to="rs_camera/aligned_depth_to_color/image_raw"/>
			 <remap from="rgb/camera_info" to="rs_camera/color/camera_info"/>
			 <remap from="cloud"                to="cloudXYZ"/>
			 
			 <param name="voxel_size" type="double" value="0.05"/>
			 <param name="decimation" type="int" value="4"/>
			 <param name="max_depth" type="double" value="4"/>
		</node>

		<node pkg="nodelet" type="nodelet" name="obstacles_detection" args="load rtabmap_ros/obstacles_detection nodelet_manager __name:=cloud2planner">
			<remap from="cloud" to="cloudXYZ"/>
			<remap from="proj_obstacles" to="planner_cloud"/>

			<param name="frame_id" type="string" value="chasiss"/>
			<param name="map_frame_id" type="string" value="map"/>
			<param name="min_cluster_size" type="int" value="20"/>
			<param name="max_obstacles_height" type="double" value="0.0"/>
		</node>

		<node pkg="robot_localization" type="ukf_localization_node" name="ukf_se" clear_params="true">
			<rosparam command="load" file="$(find porter_2dnav)/config/opensource_tracking/ukf_params.yaml" />

			<!--  Placeholder for output topic remapping
			<remap from="odometry/filtered" to=""/>
			<remap from="accel/filtered" to=""/>
			-->
		</node>
		
		<node pkg="move_base" type="move_base" name="move_base">
			<rosparam file="$(find porter_2dnav)/config/opensource_tracking/costmap_common_params.yaml" command="load" ns="global_costmap" /> 
			<rosparam file="$(find porter_2dnav)/config/opensource_tracking/costmap_common_params.yaml" command="load" ns="local_costmap" />
			<rosparam file="$(find porter_2dnav)/config/opensource_tracking/local_costmap_params.yaml" command="load" />
			<rosparam file="$(find porter_2dnav)/config/opensource_tracking/global_costmap_params.yaml" command="load" /> 
			<rosparam file="$(find porter_2dnav)/config/opensource_tracking/base_local_planner_params.yaml" command="load" />
			<remap from="cmd_vel" to="/porter/diff_drive_controller/cmd_vel" />
			<remap from="odom" to="/porter/diff_drive_controller/odom" />
			<remap from="map" to="/porter/rtabmap/proj_map"/>
		</node>

	</group>

</launch>
